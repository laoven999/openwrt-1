  # å®‰è£… feeds
      cd openwrt && ./scripts/feeds install -a || exit 1

  - name: Load custom configuration
    run: |
      # åŠ è½½è‡ªå®šä¹‰é…ç½®
      # å¦‚æžœå­˜åœ¨ files ç›®å½•ï¼Œåˆ™å°†å…¶ç§»åŠ¨åˆ° openwrt/files
      [ -e files ] && mv files openwrt/files
      # å¦‚æžœå­˜åœ¨ CONFIG_FILE æ–‡ä»¶ï¼Œåˆ™å°†å…¶ç§»åŠ¨åˆ° openwrt/.config
      [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
      # è®¾ç½® DIY_P2_SH è„šæœ¬çš„æ‰§è¡Œæƒé™
      chmod +x $DIY_P2_SH
      cd openwrt
      # æ‰§è¡Œ DIY_P2_SH è„šæœ¬
      $GITHUB_WORKSPACE/$DIY_P2_SH || exit 1

  - name: SSH connection to Actions
    uses: P3TERX/ssh2actions@v1.0.0
    if: github.event.inputs.ssh == 'true' || contains(github.event.action, 'ssh')
    env:
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

  - name: Download package
    id: package
    run: |
      # ä¸‹è½½è½¯ä»¶åŒ…
      cd openwrt
      make defconfig || exit 1
      make download -j8 || exit 1
      # æŸ¥æ‰¾å¹¶æ˜¾ç¤ºå¤§å°ä¸º -1024c çš„æ–‡ä»¶
      find dl -size -1024c -exec ls -l {} \;
      # åˆ é™¤å¤§å°ä¸º -1024c çš„æ–‡ä»¶
      find dl -size -1024c -exec rm -f {} \;

  - name: Compile the firmware
    id: compile
    run: |
      # ç¼–è¯‘å›ºä»¶
      cd openwrt
      echo -e "$(nproc) thread compile"
      make -j$(nproc) || make -j1 || make -j1 V=s || exit 1

  - name: Check space usage
    if: ${{ !cancelled() }}
    run: df -hT

  - name: Upload bin directory
    uses: actions/upload-artifact@main
    if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
    with:
      name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
      path: openwrt/bin

  - name: Organize files
    id: organize
    if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
    run: |
      # æ•´ç†æ–‡ä»¶
      cd openwrt/bin/targets/*/*
      # åˆ é™¤ packages ç›®å½•
      rm -rf packages
      # å°†å½“å‰ç›®å½•è·¯å¾„ä¿å­˜åˆ°çŽ¯å¢ƒå˜é‡ FIRMWARE ä¸­
      echo "FIRMWARE=$PWD" >> $GITHUB_ENV
      echo "status=success" >> $GITHUB_OUTPUT

  - name: Upload firmware directory
    uses: actions/upload-artifact@main
    if: steps.organize.outputs.status == 'success' && !cancelled()
    with:
      name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
      path: ${{ env.FIRMWARE }}

  - name: Generate release tag
    id: tag
    if: env.UPLOAD_RELEASE == 'true' && !cancelled()
    run: |
      # ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
      touch release.txt
      [ ${UPLOAD_GOFILE} = true && ${{ steps.gofile.outputs.url }} ] && echo "ðŸ”— [GoFile](${{ steps.gofile.outputs.url }})" >> release.txt
      echo "status=success" >> $GITHUB_OUTPUT

  - name: Upload firmware to release
    uses: softprops/action-gh-release@master
    if: steps.tag.outputs.status == 'success' && !cancelled()
    env:
      GITHUB_TOKEN: ${{ secrets.OPEN }}
    with:
      tag_name: ${{ steps.tag.outputs.release_tag }}
      body_path: release.txt
      files: ${{ env.FIRMWARE }}/*

  - name: Delete workflow runs
    uses: Mattraks/delete-workflow-runs@main
    with:
      retain_days: 0
      keep_minimum_runs: 2

  - name: Remove old Releases
    uses: dev-drprasad/delete-older-releases@master
    if: env.UPLOAD_RELEASE == 'true' && !cancelled()
    with:
      keep_latest: 3
      delete_tags: true
    env:
      GITHUB_TOKEN: ${{ secrets.OPEN }}
