steps:
  - name: Checkout
    uses: actions/checkout@v2

  - name: Set up Node.js 20.x
    uses: actions/setup-node@v4
    with:
      node-version: '20.x'

  - name: Initialization environment
    env:
      DEBIAN_FRONTEND: noninteractive
    run: |
      # åˆå§‹åŒ–çŽ¯å¢ƒ
      # åˆ é™¤æ—§çš„è½¯ä»¶æºã€æ–‡ä»¶å’Œç›®å½•
      sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
      # æ›´æ–°è½¯ä»¶æº
      sudo -E apt-get -qq update
      # å®‰è£…ä¾èµ–åŒ…
      sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2004) || exit 1
      # æ¸…ç†æ— ç”¨çš„è½¯ä»¶åŒ…
      sudo -E apt-get -qq autoremove --purge
      # æ¸…ç†ç¼“å­˜
      sudo -E apt-get -qq clean
      # è®¾ç½®æ—¶åŒº
      sudo timedatectl set-timezone "$TZ"
      # åˆ›å»ºå·¥ä½œç›®å½•
      sudo mkdir -p /workdir
      # è®¾ç½®å·¥ä½œç›®å½•çš„æ‰€æœ‰è€…
      sudo chown $USER:$GROUPS /workdir

  - name: Clone source code
    working-directory: /workdir
    run: |
      # å…‹éš†æºä»£ç 
      df -hT $PWD
      git clone $REPO_URL -b $REPO_BRANCH openwrt || exit 1
      ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

  - name: Load custom feeds
    run: |
      # åŠ è½½è‡ªå®šä¹‰ feeds
      # å¦‚æžœå­˜åœ¨ feeds é…ç½®æ–‡ä»¶ï¼Œåˆ™å°†å…¶ç§»åŠ¨åˆ° openwrt/feeds.conf.default
      [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
      # è®¾ç½® DIY_P1_SH è„šæœ¬çš„æ‰§è¡Œæƒé™
      chmod +x $DIY_P1_SH
      cd openwrt
      # æ‰§è¡Œ DIY_P1_SH è„šæœ¬
      $GITHUB_WORKSPACE/$DIY_P1_SH || exit 1

  - name: Update feeds
    run: |
      # æ›´æ–° feeds
      cd openwrt && ./scripts/feeds update -a || exit 1

  - name: Install dependencies
    run: |
      # å®‰è£…ä¾èµ–
      cd openwrt
      make package/symlinks
      make -j$(nproc) defconfig
      make -j$(nproc) download
      make -j$(nproc) || exit 1

  - name: Install feeds
    run: |
    # å®‰è£… feeds
    cd openwrt && ./scripts/feeds install -a || exit 1

  - name: Load custom configuration
    run: |
      # åŠ è½½è‡ªå®šä¹‰é…ç½®
      # å¦‚æžœå­˜åœ¨ files ç›®å½•ï¼Œåˆ™å°†å…¶ç§»åŠ¨åˆ° openwrt/files
      [ -e files ] && mv files openwrt/files
      # å¦‚æžœå­˜åœ¨ CONFIG_FILE æ–‡ä»¶ï¼Œåˆ™å°†å…¶ç§»åŠ¨åˆ° openwrt/.config
      [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
      # è®¾ç½® DIY_P2_SH è„šæœ¬çš„æ‰§è¡Œæƒé™
      chmod +x $DIY_P2_SH
      cd openwrt
      # æ‰§è¡Œ DIY_P2_SH è„šæœ¬
      $GITHUB_WORKSPACE/$DIY_P2_SH || exit 1

  - name: SSH connection to Actions
    uses: P3TERX/ssh2actions@v1.0.0
    if: github.event.inputs.ssh == 'true' || contains(github.event.action, 'ssh')
    env:
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

  - name: Download package
    id: package
    run: |
      # ä¸‹è½½è½¯ä»¶åŒ…
      cd openwrt
      make defconfig || exit 1
      make download -j8 || exit 1
      # æŸ¥æ‰¾å¹¶æ˜¾ç¤ºå¤§å°ä¸º -1024c çš„æ–‡ä»¶
      find dl -size -1024c -exec ls -l {} \;
      # åˆ é™¤å¤§å°ä¸º -1024c çš„æ–‡ä»¶
      find dl -size -1024c -exec rm -f {} \;

  - name: Compile the firmware
    id: compile
    run: |
      # ç¼–è¯‘å›ºä»¶
      cd openwrt
      echo -e "$(nproc) thread compile"
      make -j$(nproc) || make -j1 || make -j1 V=s || exit 1

  - name: Check space usage
    # Remove unnecessary if condition
    run: df -hT

  - name: Upload bin directory
    uses: actions/upload-artifact@main
    if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
    with:
      name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
      path: openwrt/bin

  - name: Organize files
    id: organize
    if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
    run: |
      # æ•´ç†æ–‡ä»¶
      cd openwrt/bin/targets/*/*
      # åˆ é™¤ packages ç›®å½•
      rm -rf packages
      # å°†å½“å‰ç›®å½•è·¯å¾„ä¿å­˜åˆ°çŽ¯å¢ƒå˜é‡ FIRMWARE ä¸­
      echo "FIRMWARE=$PWD" >> $GITHUB_ENV
      echo "status=success" >> $GITHUB_OUTPUT

  - name: Upload firmware directory
    uses: actions/upload-artifact@main
    if: steps.organize.outputs.status == 'success' && !cancelled()
    with:
      name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
      path: ${{ env.FIRMWARE }}

  - name: Generate release tag
    id: tag
    if: env.UPLOAD_RELEASE == 'true' && !cancelled()
    run: |
      # ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
      echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
      touch release.txt
      [ ${UPLOAD_GOFILE} = true && ${{ steps.gofile.outputs.url }} ] && echo "ðŸ”— [GoFile](${{ steps.gofile.outputs.url }})" >> release.txt
      echo "status=success" >> $GITHUB_OUTPUT

  - name: Upload firmware to release
    uses: softprops/action-gh-release@master
    if: steps.tag.outputs.status == 'success' && !cancelled()
    env:
      GITHUB_TOKEN: ${{ secrets.OPEN }}
    with:
      tag_name: ${{ steps.tag.outputs.release_tag }}
      body_path: release.txt
      files: ${{ env.FIRMWARE }}/*

  - name: Delete workflow runs
    uses: Mattraks/delete-workflow-runs@main
    with:
      retain_days: 0
      keep_minimum_runs: 2

  - name: Remove old Releases
    uses: dev-drprasad/delete-older-releases@master
    if: env.UPLOAD_RELEASE == 'true' && !cancelled()
    with:
      keep_latest: 3
      delete_tags: true
    env:
      GITHUB_TOKEN: ${{ secrets.OPEN }}
